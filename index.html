<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot 21 - App de Idiomas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .screen {
            display: none;
        }
        .active-screen {
            display: block;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="min-h-screen w-full">

        <!-- ==================================================== -->
        <!-- 1. TELA DE LOGIN                                     -->
        <!-- ==================================================== -->
        <div id="login-screen" class="screen active-screen flex items-center justify-center min-h-screen bg-gray-100">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-slate-900">Polyglot 21</h1>
                    <p class="text-slate-500 mt-2">Aprenda um idioma em 21 dias.</p>
                </div>
                <!-- Login/Register Tabs -->
                <div class="flex border-b">
                    <button id="login-tab-button" class="flex-1 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600">Login</button>
                    <button id="register-tab-button" class="flex-1 py-2 font-semibold text-slate-500">Registrar</button>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-slate-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-slate-700">Senha</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="text-right">
                        <a href="#" class="text-sm text-indigo-600 hover:underline">Esqueceu a senha?</a>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Entrar</button>
                </form>

                <!-- Register Form -->
                <form id="register-form" class="space-y-6 hidden">
                    <div>
                        <label for="register-email" class="text-sm font-medium text-slate-700">Email</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="register-password" class="text-sm font-medium text-slate-700">Senha</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Criar Conta</button>
                </form>
                <p id="auth-error" class="text-center text-sm text-red-600"></p>
            </div>
        </div>

        <!-- ==================================================== -->
        <!-- MAIN APP WRAPPER (post-login)                        -->
        <!-- ==================================================== -->
        <div id="main-app" class="screen md:flex">
            <!-- Sidebar/Navigation -->
            <nav class="bg-white md:w-64 md:min-h-screen md:border-r border-slate-200 p-4 space-y-4 flex flex-col">
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">Polyglot 21</h1>
                    <p id="user-email-display" class="text-xs text-slate-500 truncate"></p>
                </div>
                <div class="space-y-2 flex-grow">
                    <button data-screen="language-choice-screen" class="nav-button w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 transition-colors">
                        <i data-lucide="globe-2"></i> Idiomas
                    </button>
                    <button data-screen="daily-exercise-screen" class="nav-button w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 transition-colors">
                        <i data-lucide="book-open-check"></i> Exerc√≠cio Di√°rio
                    </button>
                    <button data-screen="conversation-screen" class="nav-button w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 transition-colors">
                        <i data-lucide="messages-square"></i> Conversa√ß√£o
                    </button>
                    <button data-screen="flashcards-screen" class="nav-button w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 transition-colors">
                        <i data-lucide="layers"></i> Flashcards
                    </button>
                    <button data-screen="progress-screen" class="nav-button w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 transition-colors">
                        <i data-lucide="bar-chart-3"></i> Progresso
                    </button>
                    <button data-screen="multimedia-screen" class="nav-button w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 transition-colors">
                        <i data-lucide="play-circle"></i> Multim√≠dia
                    </button>
                </div>
                <div>
                     <button id="logout-button" class="w-full text-left flex items-center gap-3 p-3 rounded-lg text-red-500 hover:bg-red-50 transition-colors">
                        <i data-lucide="log-out"></i> Sair
                    </button>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 p-4 md:p-8 bg-slate-50 overflow-y-auto" style="max-height: 100vh;">
                <!-- 2. TELA DE ESCOLHA DE IDIOMA -->
                <div id="language-choice-screen" class="screen">
                    <h2 class="text-3xl font-bold mb-6">Escolha seu Idioma</h2>
                    <div id="language-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Languages will be injected here by JS -->
                    </div>
                </div>

                <!-- 3. TELA DE TESTE DE NIVELAMENTO -->
                <div id="placement-test-screen" class="screen">
                    <h2 class="text-3xl font-bold mb-2">Teste de Nivelamento: <span id="test-language-name"></span></h2>
                    <p class="text-slate-600 mb-6">Responda as quest√µes para definirmos seu plano de estudos.</p>
                    <div id="test-container" class="bg-white p-6 rounded-lg shadow-md">
                        <div id="test-question-area">
                            <p class="text-lg font-semibold mb-4" id="question-text">Carregando quest√£o...</p>
                            <div id="question-options" class="space-y-3"></div>
                        </div>
                        <div id="test-result-area" class="hidden text-center">
                            <h3 class="text-2xl font-bold text-indigo-600">Resultado do Teste</h3>
                            <p class="text-5xl font-bold my-4" id="test-result-level">B1</p>
                            <p class="text-slate-600" id="test-result-description">N√≠vel Intermedi√°rio.</p>
                            <button id="start-learning-from-test" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700">Come√ßar a Aprender</button>
                        </div>
                        <div class="mt-6 flex justify-between items-center">
                            <p id="question-counter" class="text-sm text-slate-500">Quest√£o 1 de 20</p>
                            <button id="next-question-btn" class="bg-slate-800 text-white py-2 px-5 rounded-lg font-semibold hover:bg-slate-900 disabled:bg-slate-400" disabled>Pr√≥xima</button>
                        </div>
                    </div>
                </div>
                
                <!-- 4. TELA DE EXERC√çCIO DI√ÅRIO -->
                <div id="daily-exercise-screen" class="screen">
                     <h2 class="text-3xl font-bold mb-6">Li√ß√£o do Dia: <span id="daily-language-name">Italiano</span> - Dia <span id="daily-day-number">1</span></h2>
                     <div id="daily-exercise-container" class="bg-white p-6 rounded-lg shadow-md">
                        <!-- Exercise content will be loaded here -->
                        <p>Carregando exerc√≠cio...</p>
                     </div>
                </div>

                <!-- 5. TELA DE FLASHCARDS -->
                <div id="flashcards-screen" class="screen">
                    <h2 class="text-3xl font-bold mb-6">Meus Flashcards</h2>
                    <div id="flashcards-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Flashcards will be loaded here -->
                        <p>Nenhum flashcard salvo.</p>
                    </div>
                </div>

                <!-- 6. TELA DE CONVERSA√á√ÉO COM IA -->
                <div id="conversation-screen" class="screen">
                    <h2 class="text-3xl font-bold mb-6">Pr√°tica de Conversa√ß√£o com IA</h2>
                    <div class="bg-white rounded-lg shadow-md h-[70vh] flex flex-col">
                        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                            <!-- Chat messages will appear here -->
                             <div class="flex justify-start">
                                <div class="bg-slate-200 text-slate-800 rounded-lg p-3 max-w-xs">
                                    <p>Ciao! Come stai? Parliamo un po'.</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-slate-200 flex items-center gap-4">
                            <input type="text" id="chat-input" placeholder="Digite sua mensagem..." class="flex-1 px-4 py-2 bg-slate-100 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="chat-send-btn" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700">
                                <i data-lucide="send"></i>
                            </button>
                            <button id="chat-mic-btn" class="bg-slate-700 text-white p-3 rounded-full hover:bg-slate-800">
                                <i data-lucide="mic"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 7. TELA DE HIST√ìRICO E EVOLU√á√ÉO -->
                <div id="progress-screen" class="screen">
                    <h2 class="text-3xl font-bold mb-6">Meu Progresso</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold mb-4">Progresso nos 21 Dias</h3>
                            <!-- Placeholder for chart -->
                            <div class="h-64 bg-slate-100 rounded-md flex items-center justify-center">
                                <p class="text-slate-500">Gr√°fico de progresso aparecer√° aqui.</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="font-semibold mb-4">Resumo da IA</h3>
                             <div id="ai-summary" class="space-y-3 text-sm text-slate-600">
                                <p><strong>Pontos Fortes:</strong> Vocabul√°rio de sauda√ß√µes.</p>
                                <p><strong>Pontos a Melhorar:</strong> Conjuga√ß√£o de verbos no passado.</p>
                                <p><strong>Dica:</strong> Tente usar os flashcards de verbos por 10 minutos todos os dias.</p>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- 8. TELA DE MULTIM√çDIA -->
                <div id="multimedia-screen" class="screen">
                    <h2 class="text-3xl font-bold mb-6">Recursos Multim√≠dia</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Pr√°tica de Listening</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow-md">Di√°logo: No restaurante</div>
                                <div class="bg-white p-4 rounded-lg shadow-md">Di√°logo: Comprando passagens</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4">R√°dios Online</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow-md">Rai Radio 1 (It√°lia)</div>
                                <div class="bg-white p-4 rounded-lg shadow-md">Catalunya R√†dio (Catalunha)</div>
                            </div>
                        </div>
                         <div>
                            <h3 class="text-xl font-semibold mb-4">Podcasts</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow-md">Podcast: Coffee Break Italian</div>
                                <div class="bg-white p-4 rounded-lg shadow-md">Podcast: Easy Catalan</div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO ---
        const firebaseConfig = {
  apiKey: "AIzaSyDOBf1JUIvhsIrz35NNGWRyxy7-coANnrc",
  authDomain: "polyglot-21-app.firebaseapp.com",
  projectId: "polyglot-21-app",
  storageBucket: "polyglot-21-app.firebasestorage.app",
  messagingSenderId: "413429294857",
  appId: "1:413429294857:web:1bc423c522d4f79d5b15d8"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- ESTADO DA APLICA√á√ÉO ---
        let currentUser = null;
        let currentLanguage = null;
        let userData = {};

        // --- L√ìGICA DA API (GEMINI) ---
        // This is a mock function. In a real scenario, you would make a fetch call to the Gemini API.
        async function callGeminiAPI(prompt, context = {}) {
            console.log("Chamando API da IA com o prompt:", prompt);
            // Simula√ß√£o de delay da rede
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Mock responses based on prompt
            if (prompt.includes("gerar 20 quest√µes de nivelamento para o idioma")) {
                return {
                    questions: Array.from({ length: 20 }, (_, i) => ({
                        question: `Qual a tradu√ß√£o de "bom dia" em ${context.language}?`,
                        options: ["Buongiorno", "Bon dia", "BunƒÉ diminea»õa", "Bom dia"],
                        answer: i % 2 === 0 ? "Buongiorno" : "Bon dia"
                    }))
                };
            }
            if (prompt.includes("gerar exerc√≠cio do dia")) {
                return {
                    type: "multiple_choice",
                    title: "Sauda√ß√µes e Apresenta√ß√µes",
                    question: "Complete a frase: 'Io ______ Marco.'",
                    options: ["sono", "sei", "√®", "siamo"],
                    correct_answer: "sono",
                    explanation: "'Sono' √© a conjuga√ß√£o correta do verbo 'essere' (ser/estar) para a primeira pessoa do singular ('Io')."
                }
            }
            if(prompt.includes("conversa")) {
                return {
                    response: "Molto bene, grazie! E tu? Cosa hai fatto oggi?",
                    correction: "Sua frase est√° perfeita!"
                }
            }
            return { response: "Resposta simulada da IA." };
        }


        // --- L√ìGICA DE NAVEGA√á√ÉO ---
        const screens = document.querySelectorAll('.screen');
        const navButtons = document.querySelectorAll('.nav-button');

        function navigateTo(screenId) {
            screens.forEach(s => {
                if(s.id === screenId) {
                   s.classList.add('active-screen');
                } else {
                   s.classList.remove('active-screen');
                }
            });
            
            // Highlight active nav button
            navButtons.forEach(btn => {
                if (btn.dataset.screen === screenId) {
                    btn.classList.add('bg-slate-100', 'text-indigo-600');
                } else {
                    btn.classList.remove('bg-slate-100', 'text-indigo-600');
                }
            });
            console.log(`Navegando para: ${screenId}`);
        }

        // --- L√ìGICA DE AUTENTICA√á√ÉO ---
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const loginTab = document.getElementById('login-tab-button');
        const registerTab = document.getElementById('register-tab-button');

        function handleAuthError(error) {
            console.error("Authentication Error:", error);
            if (error.code === 'auth/operation-not-allowed') {
                authError.innerHTML = '<strong>Erro de Configura√ß√£o:</strong> O login por e-mail/senha n√£o est√° ativado. Por favor, ative este m√©todo no seu console do Firebase.';
            } else if (error.code === 'auth/invalid-credential') {
                 authError.textContent = "Email ou senha inv√°lidos.";
            } else {
                authError.textContent = "Ocorreu um erro. Tente novamente.";
            }
        }

        loginTab.addEventListener('click', () => {
            loginTab.classList.add('text-indigo-600', 'border-indigo-600');
            loginTab.classList.remove('text-slate-500');
            registerTab.classList.remove('text-indigo-600', 'border-indigo-600');
            registerTab.classList.add('text-slate-500');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('text-indigo-600', 'border-indigo-600');
            registerTab.classList.remove('text-slate-500');
            loginTab.classList.remove('text-indigo-600', 'border-indigo-600');
            loginTab.classList.add('text-slate-500');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log("Usu√°rio logado:", user.uid);
                document.getElementById('user-email-display').textContent = user.email;
                await loadUserData();
                navigateTo('main-app');
                navigateTo('language-choice-screen');
            } else {
                currentUser = null;
                console.log("Nenhum usu√°rio logado.");
                navigateTo('login-screen');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value);
            } catch (error) {
                handleAuthError(error);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value);
                // Create user profile in Firestore
                const userRef = doc(db, `artifacts/${appId}/users`, userCredential.user.uid);
                await setDoc(userRef, {
                    email: userCredential.user.email,
                    createdAt: new Date(),
                    languages: {}
                });
                console.log("Usu√°rio criado e perfil salvo.");
            } catch (error) {
                handleAuthError(error);
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // --- L√ìGICA DO BANCO DE DADOS (FIRESTORE) ---
        async function loadUserData() {
            if (!currentUser) return;
            const userRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                userData = docSnap.data();
                console.log("Dados do usu√°rio carregados:", userData);
            } else {
                console.log("Nenhum documento de usu√°rio encontrado! Criando um novo...");
                 userData = {
                    email: currentUser.email,
                    createdAt: new Date(),
                    languages: {}
                };
                await setDoc(userRef, userData);
            }
            renderLanguageChoices();
        }

        async function updateUserLanguageData(languageId, data) {
            if (!currentUser) return;
            const existingLangData = userData.languages?.[languageId] || {};
            const userRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            const updatePayload = {
                [`languages.${languageId}`]: {
                    ...existingLangData,
                    ...data
                }
            };
            await updateDoc(userRef, updatePayload);
            await loadUserData(); // Refresh local data
        }


        // --- L√ìGICA DAS TELAS ---

        // 2. ESCOLHA DE IDIOMA
        const languages = [
            { id: 'italian', name: 'Italiano', flag: 'üáÆüáπ' },
            { id: 'catalan', name: 'Catal√£o', flag: 'üü®üü•' },
            { id: 'romanian', name: 'Romeno', flag: 'üá∑üá¥' },
        ];

        function renderLanguageChoices() {
            const container = document.getElementById('language-list');
            container.innerHTML = '';
            languages.forEach(lang => {
                const userLangData = userData.languages?.[lang.id];
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer';
                card.innerHTML = `
                    <div class="text-4xl mb-4">${lang.flag}</div>
                    <h3 class="text-xl font-bold">${lang.name}</h3>
                    <p class="text-slate-500 mb-4">N√≠vel: ${userLangData?.level || 'N√£o iniciado'}</p>
                    ${userLangData ? 
                        `<button class="continue-btn w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700">Continuar</button>` :
                        `<button class="start-btn w-full bg-slate-800 text-white py-2 rounded-lg font-semibold hover:bg-slate-900">Come√ßar</button>`
                    }
                `;
                
                if(userLangData) {
                    card.querySelector('.continue-btn').onclick = () => startLearning(lang.id);
                } else {
                    card.querySelector('.start-btn').onclick = () => startPlacementTest(lang.id);
                }
                container.appendChild(card);
            });
        }
        
        function startLearning(languageId) {
            currentLanguage = languageId;
            const langName = languages.find(l => l.id === languageId).name;
            document.getElementById('daily-language-name').textContent = langName;
            // TODO: Load the correct day and exercise based on user progress
            navigateTo('daily-exercise-screen');
        }

        // 3. TESTE DE NIVELAMENTO
        let currentTestQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        async function startPlacementTest(languageId) {
            currentLanguage = languageId;
            const langName = languages.find(l => l.id === languageId).name;
            document.getElementById('test-language-name').textContent = langName;
            navigateTo('placement-test-screen');
            
            // Reset test state
            document.getElementById('test-question-area').style.display = 'block';
            document.getElementById('test-result-area').classList.add('hidden');
            document.getElementById('next-question-btn').style.display = 'inline-flex';
            currentQuestionIndex = 0;
            score = 0;

            // Generate questions with AI
            const aiResponse = await callGeminiAPI(`gerar 20 quest√µes de nivelamento para o idioma ${langName}`, { language: langName });
            currentTestQuestions = aiResponse.questions;
            renderQuestion();
        }

        function renderQuestion() {
            const question = currentTestQuestions[currentQuestionIndex];
            document.getElementById('question-text').textContent = question.question;
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            question.options.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.innerHTML = `
                    <input type="radio" name="option" value="${option}" id="opt-${option}" class="hidden peer">
                    <label for="opt-${option}" class="block p-3 border border-slate-300 rounded-lg cursor-pointer peer-checked:bg-indigo-100 peer-checked:border-indigo-500 hover:bg-slate-50">
                        ${option}
                    </label>
                `;
                optionsContainer.appendChild(optionEl);
            });
            document.getElementById('question-counter').textContent = `Quest√£o ${currentQuestionIndex + 1} de ${currentTestQuestions.length}`;
            document.getElementById('next-question-btn').disabled = true;
            
            optionsContainer.addEventListener('change', () => {
                document.getElementById('next-question-btn').disabled = false;
            }, { once: true });
        }

        document.getElementById('next-question-btn').addEventListener('click', () => {
            const selectedOption = document.querySelector('input[name="option"]:checked');
            if (!selectedOption) return;

            if (selectedOption.value === currentTestQuestions[currentQuestionIndex].answer) {
                score++;
            }

            currentQuestionIndex++;
            if (currentQuestionIndex < currentTestQuestions.length) {
                renderQuestion();
            } else {
                showTestResult();
            }
        });

        async function showTestResult() {
            document.getElementById('test-question-area').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'none';
            const resultArea = document.getElementById('test-result-area');
            resultArea.classList.remove('hidden');

            const percentage = (score / currentTestQuestions.length) * 100;
            let level = 'A1';
            if (percentage > 85) level = 'C1';
            else if (percentage > 70) level = 'B2';
            else if (percentage > 50) level = 'B1';
            else if (percentage > 30) level = 'A2';

            document.getElementById('test-result-level').textContent = level;
            document.getElementById('test-result-description').textContent = `Voc√™ acertou ${score} de ${currentTestQuestions.length} quest√µes.`;
            
            // Save result to Firestore
            await updateUserLanguageData(currentLanguage, {
                level: level,
                testScore: score,
                lastTestDate: new Date()
            });
        }

        document.getElementById('start-learning-from-test').addEventListener('click', () => {
            startLearning(currentLanguage);
        });

        // --- INICIALIZA√á√ÉO ---
        function init() {
            lucide.createIcons();
            navButtons.forEach(button => {
                button.addEventListener('click', () => navigateTo(button.dataset.screen));
            });
        }

        window.onload = init;

    </script>
</body>
</html>
